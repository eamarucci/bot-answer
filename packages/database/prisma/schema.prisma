generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id                    String        @id @default(cuid())
  phoneNumber           String        @unique
  
  // Configuracao default do admin (usada quando grupo nao tem config propria)
  defaultProvider       String?       // "openrouter" | "openai" | "anthropic" | "groq"
  defaultModel          String?       // ID do modelo selecionado
  defaultApiKey         String?       // Chave do provedor (criptografada)
  
  // Configuracao de vision (pode ser diferente do texto)
  defaultVisionProvider String?       // Provedor para vision (null = mesmo do texto)
  defaultVisionModel    String?       // Modelo para vision (null = mesmo do texto)
  defaultVisionApiKey   String?       // Chave para vision (null = mesma do texto)
  
  // OAuth Anthropic (para usar Claude Pro/Max)
  anthropicOAuthRefresh String?       // Refresh token (criptografado)
  anthropicOAuthExpires DateTime?     // Quando o refresh token expira
  anthropicOAuthModel   String?       // Modelo selecionado (ex: claude-sonnet-4-20250514)
  
  // OAuth OpenAI (para usar ChatGPT Plus/Pro)
  openaiOAuthRefresh    String?       // Refresh token (criptografado)
  openaiOAuthExpires    DateTime?     // Quando o refresh token expira
  openaiOAuthAccountId  String?       // Account ID para header ChatGPT-Account-Id
  openaiOAuthModel      String?       // Modelo selecionado (ex: gpt-4o)
  
  createdAt             DateTime      @default(now())
  lastLoginAt           DateTime?
  
  groupConfigs          GroupConfig[]
  authCodes             AuthCode[]
}

model GroupConfig {
  id            String   @id @default(cuid())
  matrixRoomId  String   @unique  // Ex: "!HSsbVMRWTcZpKxcEwg:matrix.marucci.cloud"
  
  adminId       String
  admin         Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  // Configuracao especifica do grupo (opcional - se null, usa default do admin)
  provider      String?  // Override de provedor (null = usa do admin)
  model         String   @default("auto")  // ID do modelo ou "auto"
  apiKey        String?  // Chave do provedor (criptografada)
  
  // Configuracao de vision (pode ser diferente do texto)
  visionProvider String?  // Provedor para vision (null = mesmo do texto)
  visionModel    String?  // Modelo para vision (null = mesmo do texto)
  visionApiKey   String?  // Chave para vision (null = mesma do texto)
  
  systemPrompt  String?
  isActive      Boolean  @default(true)
  allowAll      Boolean  @default(true)  // true = todos podem usar
  
  users         User[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model User {
  id              String      @id @default(cuid())
  phoneNumber     String      // Ex: "5512999999999"
  displayName     String?     // Cache do nome
  
  groupConfigId   String
  groupConfig     GroupConfig @relation(fields: [groupConfigId], references: [id], onDelete: Cascade)
  
  isEnabled       Boolean     @default(true)
  
  // Chave especifica do usuario neste grupo (opcional)
  apiKeyOverride  String?     // Criptografada
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([phoneNumber, groupConfigId])
}

model AuthCode {
  id            String    @id @default(cuid())
  code          String    // 6 digitos
  phoneNumber   String
  
  adminId       String?
  admin         Admin?    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  expiresAt     DateTime
  confirmedAt   DateTime? // Confirmado via comando no bot
  usedAt        DateTime? // Usado para fazer login
  createdAt     DateTime  @default(now())
  
  @@index([phoneNumber, code])
}

model GlobalConfig {
  id                   String   @id @default("global")
  fallbackApiKey       String   // Ultima instancia para texto
  fallbackVisionApiKey String?  // Ultima instancia para vision (null = usa fallbackApiKey)
  updatedAt            DateTime @updatedAt
}
